---
- name: Wait for nginx to be available
  ansible.builtin.wait_for:
    port: "{{ nginx_frontend_port }}"
    delay: 2
    timeout: 30

- name: Test HTTPS connection to nginx
  ansible.builtin.uri:
    url: "https://{{ dns_name }}:{{ nginx_frontend_port }}/api/gateway/v1/ping/"
    method: GET
    status_code: 200
    validate_certs: true
  register: https_test
  retries: 3
  delay: 5
  until: https_test is success
  ignore_errors: true

- name: Display success message
  ansible.builtin.debug:
    msg:
      - "âœ… ========================================="
      - "âœ… SSL Certificate Successfully Configured!"
      - "âœ… ========================================="
      - ""
      - "ğŸŒ Access URL: https://{{ dns_name }}:{{ nginx_frontend_port }}"
      - "ğŸ”’ Certificate: Valid (Let's Encrypt)"
      - "ğŸ”§ Nginx Frontend: Port {{ nginx_frontend_port }}"
      - "ğŸ¯ AAP Backend: Port {{ aap_backend_port }}"
      - ""
      - "Access your AAP instance at: https://{{ dns_name }}:{{ nginx_frontend_port }}"
      - ""
      - "âœ… ========================================="
  when: https_test is success

- name: Display warning if test failed
  ansible.builtin.debug:
    msg:
      - "âš ï¸  WARNING: HTTPS test failed!"
      - "Please verify configuration manually at https://{{ dns_name }}:{{ nginx_frontend_port }}"
  when: https_test is failed
