---
- name: Install EPEL repository
  ansible.builtin.dnf:
    name:
      - epel-release
    state: present
    disable_gpg_check: true

- name: Install nginx and certbot packages
  ansible.builtin.dnf:
    name:
      - nginx
      - certbot
    state: present
    disable_gpg_check: true

- name: Configure SELinux boolean for nginx
  block:
    - name: Set SELinux boolean using ansible.posix
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true
  rescue:
    - name: Set SELinux boolean using command (fallback)
      ansible.builtin.command: setsebool -P httpd_can_network_connect on
      changed_when: true
  when: configure_selinux | bool

- name: Create SSL directory for nginx
  ansible.builtin.file:
    path: "{{ _nginx_ssl_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if nginx is currently running
  ansible.builtin.systemd:
    name: nginx
  register: nginx_status
  ignore_errors: true

- name: Display nginx status
  ansible.builtin.debug:
    msg: "Nginx service status: {{ nginx_status.status.ActiveState | default('not installed') }}"
