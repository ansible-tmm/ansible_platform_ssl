---
- name: Determine RHEL version
  ansible.builtin.set_fact:
    rhel_version: "{{ ansible_distribution_major_version }}"

- name: Install EPEL repository for RHEL 9
  ansible.builtin.dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
    state: present
    disable_gpg_check: true
  when: rhel_version == "9"

- name: Install EPEL repository for RHEL 8
  ansible.builtin.dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm"
    state: present
    disable_gpg_check: true
  when: rhel_version == "8"

- name: Install nginx and certbot packages
  ansible.builtin.dnf:
    name:
      - nginx
      - certbot
    state: present
    disable_gpg_check: true

- name: Configure SELinux boolean for nginx
  block:
    - name: Set SELinux boolean using ansible.posix
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true
  rescue:
    - name: Set SELinux boolean using command (fallback)
      ansible.builtin.command: setsebool -P httpd_can_network_connect on
      changed_when: true
  when: configure_selinux | bool

- name: Add custom nginx port to SELinux
  ansible.builtin.command: semanage port -a -t http_port_t -p tcp {{ nginx_frontend_port }}
  register: semanage_result
  failed_when:
    - semanage_result.rc != 0
    - "'already defined' not in semanage_result.stderr"
  changed_when: semanage_result.rc == 0
  when: configure_selinux | bool

- name: Create SSL directory for nginx
  ansible.builtin.file:
    path: "{{ _nginx_ssl_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if nginx is currently running
  ansible.builtin.systemd:
    name: nginx
  register: nginx_status
  ignore_errors: true

- name: Display nginx status
  ansible.builtin.debug:
    msg: "Nginx service status: {{ nginx_status.status.ActiveState | default('not installed') }}"
