---
- name: Check for AAP in ec2-user home directory
  ansible.builtin.stat:
    path: "/home/ec2-user/aap/gateway/proxy.yml"
  register: ec2_user_aap_config

- name: Check for AAP in current user home directory
  ansible.builtin.stat:
    path: "/home/{{ ansible_user_id }}/aap/gateway/proxy.yml"
  register: user_aap_config
  when: ansible_user_id != 'ec2-user'

- name: Check for system-wide AAP installation
  ansible.builtin.stat:
    path: "/etc/ansible-automation-platform/gateway/proxy.yml"
  register: system_aap_config

- name: Set proxy config path to ec2-user location
  ansible.builtin.set_fact:
    aap_proxy_config_path: "/home/ec2-user/aap/gateway/proxy.yml"
  when: ec2_user_aap_config.stat.exists

- name: Set proxy config path to current user location
  ansible.builtin.set_fact:
    aap_proxy_config_path: "/home/{{ ansible_user_id }}/aap/gateway/proxy.yml"
  when:
    - not ec2_user_aap_config.stat.exists
    - user_aap_config is defined
    - user_aap_config.stat.exists

- name: Set proxy config path to system location
  ansible.builtin.set_fact:
    aap_proxy_config_path: "/etc/ansible-automation-platform/gateway/proxy.yml"
  when:
    - not ec2_user_aap_config.stat.exists
    - (user_aap_config is not defined or not user_aap_config.stat.exists)
    - system_aap_config.stat.exists

- name: Check if AAP gateway proxy config exists at final path
  ansible.builtin.stat:
    path: "{{ aap_proxy_config_path }}"
  register: proxy_config_stat

- name: Display detected configuration location
  ansible.builtin.debug:
    msg: "Found AAP configuration at: {{ aap_proxy_config_path }}"
  when: proxy_config_stat.stat.exists

- name: Fail if AAP gateway proxy config not found
  ansible.builtin.fail:
    msg: |
      AAP gateway proxy config not found!
      Checked locations:
        - /home/ec2-user/aap/gateway/proxy.yml
        - /home/{{ ansible_user }}/aap/gateway/proxy.yml
        - /etc/ansible-automation-platform/gateway/proxy.yml
      Is this a containerized AAP 2.x+ installation?
  when: not proxy_config_stat.stat.exists

- name: Read current AAP proxy configuration
  ansible.builtin.slurp:
    src: "{{ aap_proxy_config_path }}"
  register: proxy_config_content

- name: Parse proxy configuration
  ansible.builtin.set_fact:
    current_proxy_config: "{{ proxy_config_content.content | b64decode | from_yaml }}"

- name: Extract current AAP port
  ansible.builtin.set_fact:
    current_aap_port: "{{ current_proxy_config.gateway_http_ports[0].number | default(443) }}"

- name: Display current AAP configuration
  ansible.builtin.debug:
    msg:
      - "Current AAP Port: {{ current_aap_port }}"
      - "Target Backend Port: {{ aap_backend_port }}"
      - "Port Change Required: {{ current_aap_port | int != aap_backend_port | int }}"

- name: Check if automation-gateway-proxy service exists
  ansible.builtin.systemd:
    name: automation-gateway-proxy
  register: gateway_proxy_service
  ignore_errors: true

- name: Warn if service not found
  ansible.builtin.debug:
    msg: "WARNING: automation-gateway-proxy service not found. Skipping service management."
  when: gateway_proxy_service.failed
