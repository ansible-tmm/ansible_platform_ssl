---
- name: Stop nginx for certbot standalone mode
  ansible.builtin.systemd:
    name: nginx
    state: stopped
  when: nginx_status.status.ActiveState is defined and nginx_status.status.ActiveState == "active"

- name: Stop AAP gateway-proxy temporarily for certbot
  ansible.builtin.systemd:
    name: automation-gateway-proxy
    state: stopped
    scope: user
  become: true
  become_user: "{{ aap_user }}"
  register: gateway_stopped
  ignore_errors: true

- name: Wait for port 443 to be released
  ansible.builtin.wait_for:
    port: 443
    state: stopped
    timeout: 30
  when: gateway_stopped is success

- name: Issue SSL certificate with certbot
  block:
    - name: Run certbot standalone
      ansible.builtin.command: >
        certbot certonly --standalone
        -d {{ dns_name }}
        --email {{ letsencrypt_email }}
        --noninteractive
        --agree-tos
      register: certbot_result
      until: certbot_result is not failed
      retries: "{{ certbot_retries }}"
      delay: "{{ certbot_retry_delay }}"
      changed_when: "'Successfully received certificate' in certbot_result.stdout or 'Certificate not yet due for renewal' in certbot_result.stdout"

    - name: Display certbot output
      ansible.builtin.debug:
        var: certbot_result.stdout_lines

  rescue:
    - name: Display certbot error
      ansible.builtin.debug:
        msg:
          - "‚ùå Failed to obtain SSL certificate from Let's Encrypt"
          - "Please check https://letsencrypt.status.io/ to verify service status"
          - "Error: {{ certbot_result.stderr | default('Unknown error') }}"

    - name: Fail the playbook
      ansible.builtin.fail:
        msg: "Unable to obtain SSL certificate. Cannot continue."

- name: Find certificate directory in letsencrypt
  ansible.builtin.find:
    paths: "{{ _letsencrypt_live_dir }}"
    file_type: directory
  register: cert_dirs

- name: Get the most recent certificate directory
  ansible.builtin.set_fact:
    certificate_path: "{{ (cert_dirs.files | sort(attribute='mtime', reverse=true) | first).path }}"

- name: Display certificate path
  ansible.builtin.debug:
    msg: "Certificate located at: {{ certificate_path }}"

- name: Copy SSL private key to nginx directory
  ansible.builtin.copy:
    remote_src: true
    src: "{{ certificate_path }}/privkey.pem"
    dest: "{{ _nginx_ssl_dir }}/aap.key"
    owner: root
    group: root
    mode: '0600'

- name: Copy SSL certificate to nginx directory
  ansible.builtin.copy:
    remote_src: true
    src: "{{ certificate_path }}/fullchain.pem"
    dest: "{{ _nginx_ssl_dir }}/aap.crt"
    owner: root
    group: root
    mode: '0644'

- name: Restart AAP gateway-proxy after certbot
  ansible.builtin.systemd:
    name: automation-gateway-proxy
    state: started
    scope: user
  become: true
  become_user: "{{ aap_user }}"
  when: gateway_stopped is success

- name: Wait for AAP to be available again
  ansible.builtin.wait_for:
    port: "{{ aap_backend_port }}"
    delay: 3
    timeout: 60
  when: gateway_stopped is success
